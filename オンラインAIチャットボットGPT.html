
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
    <title>Study Buddy</title>
    <style>
body{zoom:3;}
.message.user {
  display: flex;
  margin-bottom: 10px;
  justify-content: flex-end;
}
.message.ai {
  display: flex;
  margin-bottom: 10px;
  text-align: left;
}
.bubble {
  background-color: #bbff6d; /* é»„ç·‘è‰²ã®å¹ãå‡ºã—ã®èƒŒæ™¯è‰² */
  color: black;
  padding: 12px;
  border-radius: 8px;
  max-width: 60%;
  position: relative;
  overflow: hidden;
  font-size: 10px;
}

.bubble::before {
  content: '';
  position: absolute;
  bottom: -8px;
  right: 10px;
  border-style: solid;
  border-width: 8px 8px 0 0;
  border-color: #FFFFE0 transparent transparent transparent;
} /*
div[id^="aidiv"]{
  background-color: #f7f7f8;  ç™½ã„å¹ãå‡ºã—ã®èƒŒæ™¯è‰² 
  justify-content: flex-start;
} */
.ai .bubble {
  background-color: #f7f7f8; /* ç™½ã„å¹ãå‡ºã—ã®èƒŒæ™¯è‰² */
  justify-content: flex-start;
}

@keyframes slideIn {
  0% {
    transform: translateX(100%);
  }
  100% {
    transform: translateX(0);
  }
}

.bubble {
  animation: slideIn ease-in-out;
}
#chat-container {
  position: fixed;
  bottom: 0;
  left: 6px;
  right: 6px; /* å³å´ã®ä½™ç™½ã®å¹…ã‚’è¨­å®š */
}
#user-input {
  background-color:#ebf7ff;
  width: 17.6rem; /* é€ä¿¡ãƒœã‚¿ãƒ³ã®å¹…åˆ†ã‚’å¼•ã„ãŸå¹…ã«è¨­å®š */
  margin-right: 0px; /* ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã¨é€ä¿¡ãƒœã‚¿ãƒ³ã®é–“ã«éš™é–“ã‚’è¨­ã‘ã‚‹å ´åˆã€å¿…è¦ã«å¿œã˜ã¦ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ */
}
.message.user .bubble::before {
  right: auto;
  left: -10px;
  border-width: 8px 0 8px 8px;
  border-color: transparent transparent transparent #bbff6d;
}
/*GET*/
#loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 9999;
}

.spinner {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 60px;
  height: 60px;
  margin: -30px 0 0 -30px;
  border-radius: 50%;
  border: 5px solid #fff;
  border-top-color: #000;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
.choice {
  background-color: #eff3ff;
  border-color: #5d4ae4;
  color: #5d4ae4;
  border: 1px solid #5d4ae4; /* æ ç·šã‚’å®šç¾© */
  border-radius: 5px; /* è§’ä¸¸ã‚’å®šç¾© */
  padding: 10px 20px; /* ãƒ†ã‚­ã‚¹ãƒˆã¨æ ç·šã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¨­ã‘ã‚‹ */
  font-size: 18px; /* ãƒ†ã‚­ã‚¹ãƒˆã®ã‚µã‚¤ã‚ºã‚’æŒ‡å®š */
  cursor: pointer; /* ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ‰‹ã®å½¢ã«å¤‰æ›´ */
  zoom:0.45;
}
    </style>
    
</head>
<body>
  
  <center><h2 id="main"><img src="ei-home.png" width="18" height="18" alt="å†èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³" onclick="window.location.reload();">ã€€ã€€GPT3.5ã€€ã€€<img src="ei-random.png" width="18" height="18" alt="åˆ‡æ›ãˆãƒœã‚¿ãƒ³" onclick="toggleCstUrl();"></h2></center>
    <div id="chat-container">
        <div id="chat-log">
        </div>
        <div id="loading" style="display:none;">
          <div class="spinner"></div>
        </div>
        <input type="text" id="user-input" oninput="checkTextbox()" placeholder="Send a message." autofocus />
        <img src="ei-send.png" width="18" height="18" alt="é€ä¿¡ãƒãƒ¼ã‚¯" id="sendi" onclick="processUserInput();">
        
    </div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    function deleteCookie() {
			document.cookie = "key=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
			alert("å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
      window.location.reload();
		}
      function checkCookieAndAssign() {
      var cookieName = "key=";
      var decodedCookie = decodeURIComponent(document.cookie);
      var cookieArray = decodedCookie.split(';');
      
      for(var i = 0; i < cookieArray.length; i++) {
        var cookie = cookieArray[i];
        while (cookie.charAt(0) === ' ') {
          cookie = cookie.substring(1);
        }
        if (cookie.indexOf(cookieName) === 0) {
          var key = cookie.substring(cookieName.length);
          // "key"ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ãŒCookieã«ã‚ã‚‹å ´åˆã€å¤‰æ•°keyã«ä»£å…¥
            return key;
        }
      }
      // Cookieã«"key"ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤ºã—ã€å…¥åŠ›ã•ã‚ŒãŸå€¤ã‚’å¤‰æ•°keyã«ä»£å…¥
      var key = window.prompt("OpenAIã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã€å†åº¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
      if (key === null) {
        return checkCookieAndAssign();
      }
      // å…¥åŠ›ã•ã‚ŒãŸå€¤ãŒç©ºã®å ´åˆã€å†åº¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
      if (key === "") {
        return checkCookieAndAssign();
      }
      // å…¥åŠ›ã•ã‚ŒãŸå€¤ã‚’Cookieã«ä¿å­˜
      document.cookie = "key=" + key;
      
      return key;
    }
    var key = checkCookieAndAssign();
const apiKey = key;
var gptv = false;
var csturl = 'https://ja.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro&explaintext&titles=';
var alturl = 'https://ja.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro&explaintext&generator=search&gsrsearch=';
const windowHeight = window.innerHeight;
const chatLogHeight = 0.32513661202186 *windowHeight -108.16120218579;
const styleElement = document.createElement("style");
styleElement.textContent = `
body {
  background-color: #a0b5d9; /* è–„ã„ãƒ™ãƒ¼ã‚¸ãƒ¥è‰²ã®èƒŒæ™¯è‰² #F5F5DC */
  font-family: "Noto Emoji", "Segoe UI Emoji", "Apple Color Emoji", "Twemoji", sans-serif;
}
#chat-log {
  height: ${chatLogHeight}px; /* è¡¨ç¤ºã™ã‚‹é«˜ã•ã‚’æŒ‡å®š */
  overflow: scroll; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’è¡¨ç¤º */
}
p {
  font-size: 8px;
  line-height:10px;
}
button:not(.choice) {
  display: none;
}
img {
  opacity: 1;
}
.faded {
  opacity: 0.2;
}
@media (prefers-color-scheme: dark) {
  body {
    background-color: #000;
    color: #fff;
  }
  img {filter: invert(100%);}
  .ai .bubble {
    background-color: #606060; /* ç™½ã„å¹ãå‡ºã—ã®èƒŒæ™¯è‰² */
    justify-content: flex-start;
    color: #ffffff;
  }
  .bubble {
    background-color: #416a2f; /* é»„ç·‘è‰²ã®å¹ãå‡ºã—ã®èƒŒæ™¯è‰² */
    color: #ffffff;
    padding: 12px;
    border-radius: 8px;
    max-width: 60%;
    position: relative;
    overflow: hidden;
    font-size: 10px;
  }
  #user-input {
    background-color:#1d435c;
    color:#fff;
    width: 17.6rem; /* é€ä¿¡ãƒœã‚¿ãƒ³ã®å¹…åˆ†ã‚’å¼•ã„ãŸå¹…ã«è¨­å®š */
    margin-right: 0px; /* ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã¨é€ä¿¡ãƒœã‚¿ãƒ³ã®é–“ã«éš™é–“ã‚’è¨­ã‘ã‚‹å ´åˆã€å¿…è¦ã«å¿œã˜ã¦ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ */
  }
  div[id^="aidiv"]{
    background-color: #606060; /* ç™½ã„å¹ãå‡ºã—ã®èƒŒæ™¯è‰² */
    justify-content: flex-start;
  }
}
`;
checkTextbox();
const sendButton = document.createElement("button");
sendButton.textContent = "é€ä¿¡";
sendButton.addEventListener("click", processUserInput);
const msgg = document.createElement("p");
msgg.innerHTML = "Free Research Preview. Study Buddy may produce inaccurate information about people, places, or facts. Study Buddy May 18 Version";
document.getElementById("chat-container").appendChild(sendButton);
document.getElementById("chat-container").appendChild(msgg); /*
const apidel = document.createElement("a");
apidel.onclick = "deleteCookie();";
apidel.innerHTML =  "Clear API key";
apidel.style.zoom = 0.5;
document.getElementById("chat-container").appendChild(apidel);*/
document.head.appendChild(styleElement);
setTimeout(function() {
  displayMessage("ã“ã‚“ã«ã¡ã¯ï¼Study Buddyã§ã™ã€‚\nä½•ã‹çŸ¥ã‚ŠãŸã„ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼ŸğŸ˜Š", "ai","");
}, 300); // 3ç§’å¾Œã«å®Ÿè¡Œã™ã‚‹
      function checkTextbox() {
        var textboxValue = document.getElementById("user-input").value;
        var myImage = document.getElementById("sendi");
        if (textboxValue === "") {
          myImage.classList.add("faded");
          myImage.removeAttribute("onclick");
        } else {
          myImage.classList.remove("faded");
          myImage.setAttribute("onclick", "processUserInput();");
        }
      }
        // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹è¦ç´ ã‚’å–å¾—
        const chatLog = document.getElementById("chat-log");
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
        function processUserInput() {
            const userInput = document.getElementById("user-input").value;
            displayMessage(userInput, "user","");
            showLoading();
            let stn = 0;
            if (csturl === 'https://ja.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro&explaintext&generator=search&gsrsearch='){
              // showLoading();
              // let stn = 0;
            }
            searchWikipedia(userInput);
            document.getElementById("user-input").value = "";
            checkTextbox();
        }
function createDiv(index) {
  const bubbleElements = document.createElement("div");
  bubbleElements.classList.add("message", "ai");
  bubbleElements.id = "aicht" + index;
  const div = document.createElement("div"); // documentã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦å‘¼ã³å‡ºã™
  div.id = "aidiv" + index; // idå±æ€§ã«é€£ç•ªã‚’ã¤ã‘ã‚‹
  // bubbleElements.appendChild(div); // divè¦ç´ ã‚’bubbleElementsã«è¿½åŠ 
  document.body.appendChild(div);
  return div; // bubbleElementsã‚’è¿”ã™
}
let num = 0;
let stn = 0;
var b= 0;
var respall = '';
var jyanlu = '';
function printAIResponse(response,index) {
  var chars = response.split("");
  var i = 0;
  var interval = setInterval(function() {
    
    if(i < chars.length) {
      var str = chars[i];
      document.getElementById("aidiv" + index).innerHTML += str;
      i++;
      var chatLogs = document.getElementById("chat-log");
      chatLogs.scrollTop = chatLogs.scrollHeight;
    }
    else {
      clearInterval(interval);
      stn++;
      respall += response + '\n';
      if (stn === num) {
        hideLoading(respall,jyanlu);
        respall = '';
        jyanlu = '';
      }
    }
  }, 1);
}
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
function displayMessage(message, sender) {
    const messageElement = document.createElement("div");
    messageElement.classList.add("message", sender);
    const bubbleElement = document.createElement("div");
    bubbleElement.classList.add("bubble");
    const contentElement = document.createElement("div");
    if (sender === "ai") {
      num++;
      b++;
      contentElement.id = "aidiv" + b;

      printAIResponse(message,b);
    } else {
      contentElement.textContent = message;
    }
    bubbleElement.appendChild(contentElement);
    messageElement.appendChild(bubbleElement);
    chatLog.appendChild(messageElement);
    var chatLogs = document.getElementById("chat-log");
    chatLogs.scrollTop = chatLogs.scrollHeight;

  }
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›æ¬„ã§Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã¨ãã«å‡¦ç†ã‚’å®Ÿè¡Œ
        document.getElementById("user-input").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                processUserInput();
            }
        });
async function searchWikipedia(searchTerm) {
		showLoading();
    if (!gptv) {
      var sendurl = "https://api.openai.com/v1/chat/completions";
          var data = {
            "model": "gpt-3.5-turbo",
            "messages": [
             {
               "role": "user",
               "content": searchTerm
             }
            ]
          };  
        } else {
          var sendurl = "https://api.openai.com/v1/completions";
         var data = {
          model:'text-davinci-003',
          prompt: `Q: ${searchTerm}\nA: `,
          max_tokens: 2000
         }; 
        }
  const response = await fetch(sendurl, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify(data)
  });
  const { choices } = await response.json();
  if (!gptv) {
    const content = await choices[0].message.content;
    var str = content;
  } else {
    const { text } = choices[0];
    var str = text;
  }
  var replacedStr = str.replace(/\n/g, "<br>");  
  document.getElementById("loading").style.display = "none";
  displayMessage(str,"ai");
    }
    function toggleCstUrl() {
      var mainContent = document.getElementById("main").innerHTML;
      if (csturl === alturl) {
        csturl = 'https://ja.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro&explaintext&titles=';
        var updatedContent = mainContent.replace("GPT4", "GPT3.5");
        var gptv = false;

      } else {
        csturl = 'https://ja.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro&explaintext&generator=search&gsrsearch=';
        var updatedContent = mainContent.replace("GPT3.5", "GPT4");
        var gptv = true;
      }
      document.getElementById("main").innerHTML = updatedContent;
    }
function showLoading() {
  document.getElementById("loading").style.display = "block";
}
function hideLoading(inpd,jyanlu) {
            var sendata = {
                "app_id": "42119646afd848df641822a059c76893484131f6bec43d04db6a561a86296eaf",
                "title": jyanlu,
                "body": inpd,
                "max_num": 10
            };
            $.ajax({
                url: "https://labs.goo.ne.jp/api/keyword",
                type: "POST",
                data: JSON.stringify(sendata),
                contentType: "application/json",
                success: function(response) {
                    var keywords = response.keywords;
                    var keywordList = "";
                    for (var i = 0; i < keywords.length; i++) {
                        var keyword = Object.keys(keywords[i])[0];
                        // keywordList += "<li>" + keyword + "</li>";
                        if (keyword !== 'ChatWikiP') { 
                          $.ajax({
                            url: 'https://ja.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro&explaintext&titles=' + keyword,
                            type: "GET",
                            dataType: "jsonp",
                            success: function(datas) {
                              // APIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
                              var pages = datas.query.pages;
                              var output = "";
                              var hidef = false;
                              for (var pageId in pages) {
                                var page = pages[pageId];
                                var title = page.title;
                                var pageUrl = "https://ja.m.wikipedia.org/?curid=" + pageId;
                                var extract = page.extract || ""; // èª¬æ˜æ–‡ãŒundefinedã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã«è¨­å®šã™ã‚‹
                                if (extract !== "") {
                                  // ä¸€è‡´ã™ã‚‹ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã€ãƒœã‚¿ãƒ³ã‚’ä½œæˆã—ã¦ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ */
                                  var newButton = document.createElement("button");
                                  newButton.innerHTML = title;
                                  newButton.classList.add('choice');
                                  newButton.setAttribute("data-keyword", keyword);
                                  newButton.addEventListener("click", function() {
                                    searchWikipedia(title+"ã¨ã¯ï¼Ÿ");
                                  });
                                  chatLog.appendChild(newButton); 
                                  chatLog.scrollTop = chatLog.scrollHeight;
                                }
                              }
                              var hidef = true;
                              if (extract === "") {
                              }
                            },
                            error: function(error) {
                              console.log("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                            }
                          });
                        }
                        chatLog.scrollTop = chatLog.scrollHeight;
                    }
                },
                error: function(xhr, status, error) {
                    console.log("Error:", error);
                }
            });
            document.getElementById("loading").style.display = "none";
}
function delindex() {
  const choiceElements = document.querySelectorAll('.choice'); // ã‚¯ãƒ©ã‚¹åãŒã€Œchoiceã€ã®å…¨ã¦ã®è¦ç´ ã‚’å–å¾—
  const lastChoiceElement = choiceElements[choiceElements.length - 1]; // æœ€å¾Œã®è¦ç´ ã‚’å–å¾—
  for (let i = 0; i < choiceElements.length - 1; i++) {
    const choiceElement = choiceElements[i];
    choiceElement.parentNode.removeChild(choiceElement); // è¦ç´ ã‚’å‰Šé™¤
  }
  lastChoiceElement.parentNode.appendChild(lastChoiceElement); // æœ€å¾Œã®è¦ç´ ã‚’è¦ªè¦ç´ ã«è¿½åŠ 
}
    </script>
</body>
</html>
